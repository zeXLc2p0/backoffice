#!/bin/bash
#
# The samples included in this query (via joins and the where clause) should be
# kept in sync with export-prevalence.
#
set -euo pipefail
psql --no-psqlrc --quiet --set ON_ERROR_STOP= <<'SQL'
    copy (
        select
            week,
            site_type,
            specimens
        from (
            select
                to_char(coalesce(collected, encountered)::date, 'IYYY-"W"IW') as week,
                coalesce(site.details->>'type', 'unknown') as site_type,

                count(distinct sample_id) as specimens

            from warehouse.sample
            left join warehouse.encounter using (encounter_id)
            left join warehouse.site using (site_id)
            join warehouse.presence_absence using (sample_id)
            join warehouse.target using (target_id)
            join warehouse.organism using (organism_id)

            where
                (organism.lineage in
                    ('Influenza.A.H1N1'
                    ,'Influenza.A.H3N2'
                    ,'Influenza.B'
                    ,'RSV.A'
                    ,'RSV.B'
                    ,'Rhinovirus'
                    ,'Adenovirus'
                    ,'Human_metapneumovirus'
                    ,'Human_coronavirus'
                    ,'Human_parainfluenza'
                    ) or organism.lineage <@ '{Human_parainfluenza, Human_coronavirus, Enterovirus}'::ltree[])

            group by week, site_type
            order by week, site_type)
        as
            counts
        where
            week between '2018-W47' and to_char(current_date, 'IYYY-"W"IW')
    )
    to stdout
    with (format csv, header);
SQL
